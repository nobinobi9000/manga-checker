<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マンガ新刊チェッカー</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        .manga-card { display: flex; align-items: flex-start; margin-bottom: 1rem; padding: 1rem; border: 1px solid #ddd; border-radius: 8px; background: white; }
        .manga-info { flex-grow: 1; }
        .manga-image { width: 70px; height: auto; margin-right: 15px; border: 1px solid #eee; }
        .is-reserved { background-color: #fff3cd; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .tab-content { display: none; }
        .tab-content.is-active { display: block; }
    </style>
</head>
<body>
    <div id="loading" class="loading-overlay"><p>処理中...</p></div>
    
    <section class="section">
        <div class="container">
            <h1 class="title is-4">マンガ新刊チェッカー</h1>
            
            <div class="tabs is-centered is-boxed">
                <ul>
                    <li id="tab-search-btn" class="is-active"><a onclick="showTab('search')">マンガ検索</a></li>
                    <li id="tab-list-btn"><a onclick="showTab('list')">マイリスト</a></li>
                </ul>
            </div>

            <div id="tab-search" class="tab-content is-active">
                <div class="field has-addons">
                    <div class="control is-expanded">
                        <input id="search-input" class="input" type="text" placeholder="作品名を入力">
                    </div>
                    <div class="control">
                        <button class="button is-primary" id="search-button">検索</button>
                    </div>
                </div>
                <div id="search-results"></div>
            </div>

            <div id="tab-list" class="tab-content">
                <h2 class="subtitle is-5">登録済みリスト</h2>
                <div id="my-list"></div>
            </div>
        </div>
    </section>

    <script>
        const LIFF_ID = "2008959676-hW7rllQ0";
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyqGjbR2GC5AI6I7V83NHoziD4IXQghURQIERw3LGBKNYsNYHZCoWqARssmq94rtdxL2g/exec";
        let userId = "";

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('is-active'));
            document.querySelectorAll('.tabs li').forEach(el => el.classList.remove('is-active'));
            document.getElementById(`tab-${tabName}`).classList.add('is-active');
            document.getElementById(`tab-${tabName}-btn`).classList.add('is-active');
            if (tabName === 'list' && userId) loadMyList();
        }

        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    userId = profile.userId;
                    loadMyList();
                }
            } catch (err) {
                console.error("LIFF Init Error", err);
            }
        }

        async function callGas(params, method = 'POST') {
            document.getElementById('loading').style.display = 'flex';
            try {
                let url = GAS_API_URL;
                let options = { 
                    method: method,
                    mode: 'cors' // CORSを明示
                };
                if (method === 'POST') {
                    options.body = JSON.stringify(params);
                } else {
                    const query = new URLSearchParams(params).toString();
                    url += `?${query}`;
                }
                const res = await fetch(url, options);
                return await res.json();
            } catch (e) {
                console.error("GAS Call Error", e);
                return [];
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function search() {
            const titleInput = document.getElementById('search-input');
            const title = titleInput.value;
            if(!title) return;
            
            const results = await callGas({ action: 'search', title: title });
            const container = document.getElementById('search-results');
            
            if (!results || results.length === 0) {
                container.innerHTML = '<p class="has-text-grey">見つかりませんでした</p>';
                return;
            }

            container.innerHTML = results.map(item => {
                const secureImageUrl = item.imageUrl ? item.imageUrl.replace('http://', 'https://') : '';
                return `
                <div class="manga-card">
                    ${secureImageUrl ? `<img src="${secureImageUrl}" class="manga-image" alt="cover">` : ''}
                    <div class="manga-info">
                        <p><strong>${item.title}</strong></p>
                        <p class="is-size-7">${item.author || ''}</p>
                        <button class="button is-small is-link mt-2" onclick='register(${JSON.stringify(item).replace(/'/g, "&apos;")})'>追加</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        async function register(item) {
            await callGas({ action: 'register', data: { ...item, userId: userId } });
            alert("登録しました");
            showTab('list');
        }

        async function loadMyList() {
            if(!userId) return;
            const list = await callGas({ action: 'getList', userId: userId }, 'GET');
            const container = document.getElementById('my-list');
            
            if (!list || list.length === 0) {
                container.innerHTML = '<p class="has-text-grey">登録されたマンガはありません</p>';
                return;
            }

            container.innerHTML = list.map(item => `
                <div class="manga-card ${item.is_reserved ? 'is-reserved' : ''}">
                    <div class="manga-info">
                        <p><strong>${item.title_key}</strong></p>
                        <p class="is-size-7">${item.author || ''}</p>
                        <div class="mt-2">
                            <button class="button is-small" onclick="toggle('${item.id}', ${item.is_reserved})">
                                ${item.is_reserved ? '予約解除' : '予約する'}
                            </button>
                            <button class="button is-small is-danger" onclick="remove('${item.id}')">削除</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function toggle(id, current) {
            await callGas({ action: 'toggle', id: id, newStatus: !current });
            loadMyList();
        }

        async function remove(id) {
            if(confirm("削除しますか？")) {
                await callGas({ action: 'delete', id: id });
                loadMyList();
            }
        }

        // イベントリスナーの登録（onclickより確実）
        document.getElementById('search-button').addEventListener('click', search);

        // 実行開始
        init();
    </script>
</body>
</html>
