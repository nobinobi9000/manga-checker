<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マンガ登録</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        .manga-card { display: flex; align-items: flex-start; margin-bottom: 1rem; padding: 1rem; border: 1px solid #ddd; border-radius: 8px; }
        .manga-info { flex-grow: 1; }
        .manga-image { width: 70px; height: auto; margin-right: 15px; border: 1px solid #eee; }
        .is-reserved { background-color: #fff3cd; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .tab-content { display: none; }
        .tab-content.is-active { display: block; }
        .button-group { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
        /* ソートセレクトボックスのスタイル */
        .sort-container { margin-bottom: 1rem; display: flex; align-items: center; justify-content: flex-end; }
    </style>
</head>
<body>
    <div id="loading" class="loading-overlay">
        <button class="button is-loading is-large is-ghost">Loading</button>
    </div>

    <section class="section">
        <div class="container">
            <div class="tabs is-centered is-boxed">
                <ul>
                    <li id="tab-search" class="is-active"><a onclick="switchTab('search')">検索・登録</a></li>
                    <li id="tab-list"><a onclick="switchTab('list')">登録リスト</a></li>
                </ul>
            </div>
            
            <div class="has-text-centered mb-5" style="margin-top:-10px;">
                <a href="https://nobinobi9000.github.io/manga-checker/reservation/index.html"
                   target="_blank"
                   class="is-size-7 has-text-grey">
                   ▶ このサービスについて（無料）
                </a>
            </div>

            <div id="content-search" class="tab-content is-active">
                <div class="field has-addons">
                    <div class="control is-expanded">
                        <input id="title" class="input" type="text" placeholder="マンガのタイトルを入力">
                    </div>
                    <div class="control">
                        <button class="button is-link" onclick="search()">検索</button>
                    </div>
                </div>
                <div id="search-results"></div>
            </div>

            <div id="content-list" class="tab-content">
                <div class="sort-container">
                    <span class="is-size-7 mr-2">並び替え:</span>
                    <div class="select is-small">
                        <select id="sort-order" onchange="renderList()">
                            <option value="release">発売日が近い順</option>
                            <option value="name">名前順</option>
                            <option value="newest">登録順</option>
                        </select>
                    </div>
                </div>
                <div id="my-list"></div>
            </div>
        </div>
    </section>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbw0gQWC81jZ1tEKx6oZVk3Fd0Z6EveuRDzSBYNMZ-tIm0lYxceWFiR78PMt5MUNF9FJcQ/exec"; // ★要書き換え
        let userProfile = null;
        let cachedList = []; // ソートのためにリストを保持

        const AMAZON_ID = "nobinobi9000-22";
        const RAKUTEN_ID = "501ad036.07885280.501ad037.06e37a49";

        async function init() {
            await liff.init({ liffId: "2008959676-hW7rllQ0" }); // ★要書き換え
            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                userProfile = await liff.getProfile();
                loadMyList();
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('is-active'));
            document.querySelectorAll('.tabs li').forEach(el => el.classList.remove('is-active'));
            document.getElementById(`content-${tab}`).classList.add('is-active');
            document.getElementById(`tab-${tab}`).classList.add('is-active');
            if (tab === 'list') loadMyList();
        }

        async function callGas(payload) {
            document.getElementById('loading').style.display = 'flex';
            const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
            document.getElementById('loading').style.display = 'none';
            return await res.json();
        }

        async function search() {
            const title = document.getElementById('title').value;
            const results = await callGas({ action: 'search', title: title });
            const container = document.getElementById('search-results');
            container.innerHTML = results.map(item => `
                <div class="manga-card">
                    <img src="${item.imageUrl}" class="manga-image">
                    <div class="manga-info">
                        <p><strong>${item.title}</strong></p>
                        <p class="is-size-7">${item.author} / ${item.publisher}</p>
                        <p class="is-size-7">発売日: ${item.salesDate}</p>
                        <button class="button is-small is-link mt-2" onclick='register(${JSON.stringify(item)})'>登録</button>
                    </div>
                </div>
            `).join('');
        }

        async function register(item) {
            const res = await callGas({ action: 'register', data: { userId: userProfile.userId, ...item } });
            alert(res.status === 'duplicate' ? "既に登録されています" : "登録しました");
        }

        async function loadMyList() {
            const res = await fetch(`${GAS_URL}?action=getList&userId=${userProfile.userId}`);
            cachedList = await res.json();
            renderList();
        }

        function renderList() {
            const sortOrder = document.getElementById('sort-order').value;
            const container = document.getElementById('my-list');
            
            // 今日の日付 (比較用: YYYYMMDD形式に変換)
            const now = new Date();
            const todayNum = parseInt(now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0'));

            let sortedList = [...cachedList];

            // 日付を数値(YYYYMMDD)化する補助関数 ("頃"を除去)
            const parseDate = (dateStr) => {
                if (!dateStr) return 99999999;
                const cleanStr = dateStr.replace(/[^0-9]/g, ""); // 数字以外(頃など)を全削除
                return cleanStr.length === 8 ? parseInt(cleanStr) : 99999999;
            };

            if (sortOrder === 'release') {
                sortedList.sort((a, b) => {
                    const dateA = parseDate(a.sales_date);
                    const dateB = parseDate(b.sales_date);

                    const isAFuture = dateA >= todayNum;
                    const isBFuture = dateB >= todayNum;

                    // 未来 vs 過去: 未来を優先
                    if (isAFuture && !isBFuture) return -1;
                    if (!isAFuture && isBFuture) return 1;

                    if (isAFuture) {
                        // 未来同士: 今日から近い順 (昇順)
                        return dateA - dateB;
                    } else {
                        // 過去同士: 今日から近い順 (降順)
                        return dateB - dateA;
                    }
                });
            } else if (sortOrder === 'name') {
                sortedList.sort((a, b) => a.title_key.localeCompare(b.title_key, 'ja'));
            } else if (sortOrder === 'newest') {
                sortedList.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            }

            container.innerHTML = sortedList.map(item => {
                const encodedTitle = encodeURIComponent(item.title_key);
                const amazonUrl = `https://www.amazon.co.jp/gp/search?keywords=${item.isbn || encodedTitle}&tag=${AMAZON_ID}`;
                const rakutenUrl = `https://hb.afl.rakuten.co.jp/hgc/share/01/${RAKUTEN_ID}?pc=https%3A%2F%2Fsearch.rakuten.co.jp%2Fsearch%2Fmall%2F${encodedTitle}%2F`;

                return `
                <div class="manga-card ${item.is_reserved ? 'is-reserved' : ''}">
                    <img src="${item.image_url}" class="manga-image">
                    <div class="manga-info">
                        <p><strong>${item.title_key}</strong></p>
                        <p class="is-size-7">発売日: ${item.sales_date || '不明'}</p>
                        <p class="is-size-7">所有: ${item.last_purchased_vol || 0}巻</p>
                        <div class="button-group">
                            <a href="${amazonUrl}" target="_blank" class="button is-small is-warning has-text-weight-bold">Amazon</a>
                            <a href="${rakutenUrl}" target="_blank" class="button is-small is-danger has-text-weight-bold">楽天</a>
                        </div>
                        <div class="button-group mt-2">
                            <button class="button is-small is-success" onclick="markAsPurchased('${item.id}')">巻数更新</button>
                            <button class="button is-small" onclick="toggle('${item.id}', ${item.is_reserved})">
                                ${item.is_reserved ? '予約解除' : '予約済み'}
                            </button>
                            <button class="button is-small is-light" onclick="remove('${item.id}')">削除</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        async function toggle(id, current) {
            await callGas({ action: 'toggle', id: id, newStatus: !current });
            loadMyList();
        }

        async function markAsPurchased(id) {
            const vol = prompt("何巻まで購入しましたか？");
            if (vol !== null && !isNaN(vol) && vol !== "") {
                await callGas({ action: 'purchase', id: id, vol: parseInt(vol) });
                loadMyList();
            }
        }

        async function remove(id) {
            if(confirm("削除しますか？")) {
                await callGas({ action: 'delete', id: id });
                loadMyList();
            }
        }

        init();
    </script>
</body>
</html>
